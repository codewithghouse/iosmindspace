rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/user/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/user/$(request.auth.uid)).data.is_admin == true;
    }
    
    match /user/{document} {
      allow create: if request.auth.uid == document;
      allow read: if request.auth.uid == document || isAdmin();
      allow write: if request.auth.uid == document || isAdmin();
      allow delete: if request.auth.uid == document;
      
      // Allow access to fcm_tokens sub-collection
      match /fcm_tokens/{token} {
        allow create: if request.auth.uid == document;
        allow read: if request.auth.uid == document;
        allow write: if request.auth.uid == document;
        allow delete: if request.auth.uid == document;
      }
    }
    
    // Allow admin access to user collection for dashboard
    match /user/{document} {
      allow read: if request.auth != null && 
                     request.auth.uid == "Rx5Ow3bJxqMPKhTT4ZGUOxpRzqF2";
    }
    
    match /assessments/{document} {
      allow create: if true;
      allow read: if true;
      allow write: if false;
      allow delete: if false;
    }
    
    match /journal/{document} {
      allow create: if request.auth != null;
      allow read: if true;
      allow write: if request.auth != null && 
                      resource.data.uid == /databases/$(database)/documents/user/$(request.auth.uid);
      allow delete: if request.auth != null && 
                       resource.data.uid == /databases/$(database)/documents/user/$(request.auth.uid);
    }
    
    match /mood_tracker/{document} {
      allow create: if true;
      allow read: if true;
      allow write: if false;
      allow delete: if false;
    }
    
    match /tara/{document} {
      allow create: if true;
      allow read: if true;
      allow write: if false;
      allow delete: if false;
    }
    
    match /chatbot/{document} {
      allow create: if true;
      allow read: if true;
      allow write: if false;
      allow delete: if false;
    }
    
    match /tara_subscription/{document} {
      allow create: if true;
      allow read: if true;
      allow write: if false;
      allow delete: if false;
    }
    
    // ✅ FIXED: ff_push_notifications - Allow authenticated users to create and read
    match /ff_push_notifications/{document} {
      allow create: if request.auth != null;
      allow read: if request.auth != null;
      allow update: if false;
      allow delete: if false;
    }
    
    // ✅ NEW: OneSignal notifications - Allow authenticated users to create and read
    match /onesignal_notifications/{document} {
      allow create: if request.auth != null;
      allow read: if request.auth != null;
      allow update: if false;
      allow delete: if false;
    }
    
    // Conversation storage - complete transcripts of voice calls
    match /conversations/{conversationId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }
    
    // Feedback collection
    match /feedback/{document} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && request.auth.uid == resource.data.uid.id;
      allow write, delete: if false;
    }
    
    // ✅ UPDATED: Call logs collection - supports both uid (Flutter) and userId (tara-calling) formats
    match /call_logs/{document} {
      // Allow create if authenticated and uid/userId matches user's auth uid
      allow create: if request.auth != null && 
                     (request.resource.data.uid == request.auth.uid || 
                      request.resource.data.userId == request.auth.uid);
      
      // Allow admins to read all call logs
      allow read: if isAdmin();
      
      // Allow specific admin user to read all call logs
      allow read: if request.auth != null && 
                     request.auth.uid == "Rx5Ow3bJxqMPKhTT4ZGUOxpRzqF2";
      
      // Allow users to read their own call logs (supports both uid and userId fields)
      allow read: if request.auth != null && 
                     resource.data != null &&
                     (resource.data.uid == request.auth.uid || 
                      resource.data.userId == request.auth.uid);
      
      // Allow users to update their own call logs (supports both uid and userId fields)
      allow update: if request.auth != null && 
                     resource.data != null &&
                     (resource.data.uid == request.auth.uid || 
                      resource.data.userId == request.auth.uid);
      
      // Prevent deletion of call logs (for audit purposes)
      allow delete: if false;
    }
    
    // Allow FlutterFlow admin access
    match /{document=**} {
      allow read, write: if request.auth.token.email.matches("firebase@flutterflow.io");
    }
    
    // Allow admin users to read all user documents (fallback)
    match /user/{document} {
      allow read: if request.auth != null && 
                     request.auth.token.email != null &&
                     (request.auth.token.email.matches(".*@goodmind.*") || 
                      request.auth.token.email.matches(".*@admin.*"));
    }
    
    // Admin access rule for dashboard - allow read access for your specific user
    match /{document=**} {
      allow read: if request.auth != null && 
                     request.auth.uid == "Rx5Ow3bJxqMPKhTT4ZGUOxpRzqF2";
    }
    
    // Final catch-all rule (this should be last)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
